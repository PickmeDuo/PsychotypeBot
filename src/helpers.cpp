#include "psycho.hpp"

#include <iostream>
#include <cctype>
#include <sstream>
#include <algorithm>
#include <utility>

namespace Psycho {
    std::pair<unsigned char, unsigned char> PsychologicalAnalyzerBot::toLoweRu(unsigned char c1, unsigned char c2) {
        if (c1 == 0xD0 && c2 == 0x81) {
            return {0xD1, 0x91};
        } else if (c1 == 0xD0 && c2 >= 0x90 && c2 <= 0x9F) {
            return {0xD0, static_cast<unsigned char>(c2 + 0x20)};
        } else if (c1 == 0xD0 && c2 >= 0xA0 && c2 <= 0xAF) {
            return {0xD1, static_cast<unsigned char>(c2 - 0x20)};
        } else {
            return {c1, c2};
        }
    }

    std::vector<std::string> PsychologicalAnalyzerBot::parseMessage(const std::string& text) {
        std::string clear;
        clear.reserve(text.size());

        for (size_t i = 0; i < text.size(); ) {
            unsigned char c = text[i];

            if ((c == 0xD0 || c == 0xD1) && i + 1 < text.size()) {
                unsigned char c2 = text[i + 1];

                auto lower = toLoweRu(c, c2);
                clear += lower.first;
                clear += lower.second;
                i+=2;
            } else{
                clear += ' ';
                ++i;
            }
        }

        std::vector<std::string> words;
        std::istringstream iss(clear); //разбиваем по пробелам
        std::string word;

        while (iss >> word) {
            words.push_back(word); //добавляем каждое слово в вектор
        }

        return words;
    }

    std::string PsychologicalAnalyzerBot::analyzePerson(const std::string& name) {
        auto userId = tendency.find(name);

        if (userId == tendency.end()) {
            return "Нет данных для" + name;
        }

        const auto& userPsycho = userId->second;

        if (userPsycho.empty()) {
            return "Недостаточно информации для" + name;
        }

        std::vector<std::pair<std::string, int>> sorted(userPsycho.begin(), userPsycho.end());

        std::sort(sorted.begin(), sorted.end(), [](const auto& a, const auto& b) {
            return a.second > b.second;
        });
        
        std::vector<std::string> resultPsycho;

        int max1 = sorted[0].second;
        int max2 = sorted[1].second;

        for (const auto& [type, score] : sorted) {
            if (score == max1) {
                resultPsycho.push_back(type);
            }
        }

        if ((max1 - max2) < (max1 / 10)) {
            for (const auto& [type, score] : sorted) {
                if (score == max2) {
                    resultPsycho.push_back(type);
                }
            }
        } 

        std::string result;
        int n = static_cast<int>(resultPsycho.size());

        for (int i = 0; i < n; ++i) {
            result += resultPsycho[i];
            if (i + 2 == n) {
                result += " и ";
            } else if (i + 1 < n) {
                result += ", ";
            }
        }

        return result;
    } 

    std::string PsychologicalAnalyzerBot::analyzeGroup(const std::map<std::string, std::map<std::string, int>>& tendency) {
        if (tendency.empty()) {
            return "Нет данных для анализа";
        }

        std::string result;

        for (const auto& [name, score] : tendency) {
            std::string psycho = analyzePerson(name);
            result += name + ": " + psycho + "\n";
        }

        return result;
    }

    std::string PsychologicalAnalyzerBot::resultDescription(const std::string& psychotype) {
        if (psychotype == "Пикми") {
            return "Пикми — это человек, который старается показать, что он не такой, как другие, чтобы понравиться противоположному полу. Девушка пикми может говорить, что не дружит с девушками, потому что те слишком драматичные, что ей не нужен макияж, потому что настоящая красота внутри, и что она разделяет мужские увлечения вроде рыбалки или видеоигр, хотя на самом деле ей это не особо интересно. Главное для неё — выделиться, быть удобной и показать, что она лучше других девушек, потому что не требует ничего и всё терпит. В этом есть немного грусти, потому что за этим желанием понравиться часто скрывается неуверенность в себе.";
        } else if (psychotype == "Истероид") {
            return "Истероид — это человек, который очень хочет быть в центре внимания и делает всё, чтобы им восхищались. Он любит, когда на него смотрят, слушают, замечают, и может устроить целый спектакль, если чувствует, что его игнорируют. Такой человек может быть очень ярким, харизматичным, артистичным, но иногда слишком преувеличивает, драматизирует или даже врёт, чтобы казаться интереснее. Ему важно чувствовать себя особенным, уникальным, а без публики он может быстро терять мотивацию. За этим часто стоит сильная потребность в любви и одобрении, а не просто желание повыпендриваться.";
        } else if (psychotype == "Эпилептоид") {
            return "Эпилептоид — это человек, который ценит порядок, контроль и стабильность превыше всего. Он любит чёткие правила, дисциплину и когда всё идёт по плану. Такой человек может быть очень надёжным, упорным и ответственным, но при этом склонен к жёсткости, упрямству и вспышкам гнева, особенно если кто-то нарушает его границы или порядок. Он не любит неопределённость, хаос и людей, которые ведут себя слишком эмоционально или непредсказуемо. Часто эпилептоид выглядит суровым и строгим, но за этим может скрываться глубокая тревога и стремление держать мир под контролем, чтобы чувствовать себя в безопасности.";
        } else if (psychotype == "Шизоид") {
            return "Шизоид — это человек, который живёт больше в своём внутреннем мире, чем во внешнем. Он любит размышлять, фантазировать, погружаться в свои интересы и часто кажется отстранённым или в себе. Ему тяжело выражать эмоции, устанавливать близкие отношения и быть частью шумной социальной жизни — не потому что он не хочет, а потому что это утомляет или не кажется нужным. Шизоиды могут быть очень глубокими, оригинальными и творческими, но при этом выглядеть холодными или странными. На самом деле они просто другие — их мир богат, но он внутри, а не снаружи.";
        } else if (psychotype == "Гипертим") {
            return "Гипертим — это человек-энергайзер, которому всегда всего мало: людей, событий, движухи и впечатлений. Он активный, общительный, весёлый, любит быть в центре внимания, быстро загорается идеями и с энтузиазмом вовлекает в них других. Гипертим почти всегда в хорошем настроении, не сидит на месте и легко находит общий язык с кем угодно. При этом ему бывает сложно доводить дела до конца, соблюдать рамки и удерживать внимание на чём-то одном. Он может перебивать, суетиться, нарушать правила и не замечать, что переходит границы — не со зла, а просто потому что его переполняет энергия. Это такой вечный подросток, который всё время бежит вперёд, даже не глядя, куда именно.";
        } else if (psychotype == "Параноял") {
            return "Параноял — это человек с мощной целеустремлённостью, которому всегда нужно идти к своей цели, даже если все вокруг уже сдались. Он очень настойчивый, трудолюбивый и умеет стратегически мыслить. Параноял видит смысл в том, чтобы преодолевать трудности, доказывать свою правоту и достигать успеха. При этом он может быть подозрительным, восприимчивым к критике и склонным видеть скрытые мотивы в действиях других. Он не любит, когда его контролируют или ограничивают, и может воспринимать любое несогласие как угрозу. Такой человек часто выглядит жёстким и даже агрессивным, но внутри у него сильная потребность в справедливости, уважении и признании.";
        } else if (psychotype == "Эмотив") {
            return "Эмотив — это человек с глубокой чувствительностью и развитым эмоциональным восприятием, который тонко улавливает настроение окружающих и искренне сопереживает. Он доброжелательный, мягкий и заботливый, склонен ставить чужие чувства выше собственных интересов. Эмотив легко входит в положение других, умеет слушать и поддерживать, часто становится жилеткой для друзей и родных. Он стремится к гармонии, избегает конфликтов и очень тяжело переживает ссоры или разногласия. Его внутренняя жизнь насыщена: он остро чувствует радость, боль, вину, любовь. При этом эмотив может быть ранимым, застенчивым и нерешительным, бояться причинить неудобство или обидеть кого-то. Он не стремится к лидерству, предпочитая быть сердцем коллектива, а не его головой. Такой человек нуждается в тепле, душевной близости и ощущении, что его принимают таким, какой он есть.";
        } else if (psychotype == "Тревожно-Мнительный") {
            return "Тревожно-мнительный — это человек с повышенной чувствительностью к возможным угрозам и склонностью постоянно анализировать свои действия, переживать о последствиях. Он осторожный, предусмотрительный, всегда стремится избежать ошибок или неодобрения окружающих. Такой человек сомневается в себе, много думает перед принятием любого решения, нередко пересматривает в голове прошедшие события, чтобы убедиться, что всё сделал правильно. Он стремится соблюдать правила, избегает риска, предпочитает заранее продумывать запасные планы. При этом человек может быть добросовестным, внимательным к деталям и ответственным, но из-за внутреннего напряжения часто испытывает усталость и тревогу. Он болезненно воспринимает критику, боится осуждения, нуждается в поддержке и ощущении безопасности. Несмотря на внешнюю застенчивость, внутри него — буря переживаний, из которой рождается стремление быть хорошим, не подвести, не причинить никому вреда.";
        } else if (psychotype == "Депрессивно-Печальный") {
            return "Депрессивно-печальный — это человек с глубокой внутренней тягой к переживанию грусти и меланхолии, который часто ощущает тяжесть и бессилие перед жизненными трудностями. Он склонен к самоанализу и погружению в собственные мысли, что порой приводит к чувству одиночества и утраты смысла. Такой человек может казаться замкнутым и пассивным, его настроение часто колеблется между апатией и тихой тоской. Депрессивно-печальный испытывает трудности с мотивацией, ему сложно находить радость в привычных вещах и поддерживать активность. Он чувствует себя уязвимым и ранимым, склонен к самокритике и переживает из-за собственных ошибок и недостатков. При этом внутри него живёт сильная потребность в понимании, сочувствии и поддержке, но он часто боится открыть свои чувства, опасаясь быть непонятым или отвергнутым. Такой человек нуждается в заботе и тепле, которые помогут ему постепенно вернуть веру в себя и светлое будущее.";
        }
    }
    void PsychologicalAnalyzerBot::onGroupMessage(const std::string& message, const std::string& username) {
        std::vector<std::string> words = parseMessage(message);

        for (const auto& word : words) {
            for (const auto& [psychotype, key] : psychotypeKeywords) {
                auto w = key.find(word);
                if (w != key.end()) {
                    int score = w->second;
                    tendency[username][psychotype] += score;
                }
            }
        }
    }
}